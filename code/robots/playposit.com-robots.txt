<!DOCTYPE html>
<html lang="en">
<head>
    <link href="/static/css/app_new.css?v=1.597" rel="stylesheet" />
    <link rel="shortcut icon" href="//az857794.vo.msecnd.net/images/favicon.ico?v=2">
    <link href='//fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons|Roboto+Condensed:200,400,700' rel='stylesheet' type='text/css'>
    <link rel="manifest" href="/manifest.json"></link>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"><script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(e,n,t){function r(t){if(!n[t]){var o=n[t]={exports:{}};e[t][0].call(o.exports,function(n){var o=e[t][1][n];return r(o||n)},o,o.exports)}return n[t].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<t.length;o++)r(t[o]);return r}({1:[function(e,n,t){function r(){}function o(e,n,t){return function(){return i(e,[c.now()].concat(u(arguments)),n?null:this,t),n?void 0:this}}var i=e("handle"),a=e(2),u=e(3),f=e("ee").get("tracer"),c=e("loader"),s=NREUM;"undefined"==typeof window.newrelic&&(newrelic=s);var p=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],d="api-",l=d+"ixn-";a(p,function(e,n){s[n]=o(d+n,!0,"api")}),s.addPageAction=o(d+"addPageAction",!0),s.setCurrentRouteName=o(d+"routeName",!0),n.exports=newrelic,s.interaction=function(){return(new r).get()};var m=r.prototype={createTracer:function(e,n){var t={},r=this,o="function"==typeof n;return i(l+"tracer",[c.now(),e,t],r),function(){if(f.emit((o?"":"no-")+"fn-start",[c.now(),r,o],t),o)try{return n.apply(this,arguments)}finally{f.emit("fn-end",[c.now()],t)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(e,n){m[n]=o(l+n)}),newrelic.noticeError=function(e){"string"==typeof e&&(e=new Error(e)),i("err",[e,c.now()])}},{}],2:[function(e,n,t){function r(e,n){var t=[],r="",i=0;for(r in e)o.call(e,r)&&(t[i]=n(r,e[r]),i+=1);return t}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],3:[function(e,n,t){function r(e,n,t){n||(n=0),"undefined"==typeof t&&(t=e?e.length:0);for(var r=-1,o=t-n||0,i=Array(o<0?0:o);++r<o;)i[r]=e[n+r];return i}n.exports=r},{}],4:[function(e,n,t){n.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],ee:[function(e,n,t){function r(){}function o(e){function n(e){return e&&e instanceof r?e:e?f(e,u,i):i()}function t(t,r,o,i){if(!d.aborted||i){e&&e(t,r,o);for(var a=n(o),u=m(t),f=u.length,c=0;c<f;c++)u[c].apply(a,r);var p=s[y[t]];return p&&p.push([b,t,r,a]),a}}function l(e,n){v[e]=m(e).concat(n)}function m(e){return v[e]||[]}function w(e){return p[e]=p[e]||o(t)}function g(e,n){c(e,function(e,t){n=n||"feature",y[t]=n,n in s||(s[n]=[])})}var v={},y={},b={on:l,emit:t,get:w,listeners:m,context:n,buffer:g,abort:a,aborted:!1};return b}function i(){return new r}function a(){(s.api||s.feature)&&(d.aborted=!0,s=d.backlog={})}var u="nr@context",f=e("gos"),c=e(2),s={},p={},d=n.exports=o();d.backlog=s},{}],gos:[function(e,n,t){function r(e,n,t){if(o.call(e,n))return e[n];var r=t();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(e,n,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return e[n]=r,r}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],handle:[function(e,n,t){function r(e,n,t,r){o.buffer([e],r),o.emit(e,n,t)}var o=e("ee").get("handle");n.exports=r,r.ee=o},{}],id:[function(e,n,t){function r(e){var n=typeof e;return!e||"object"!==n&&"function"!==n?-1:e===window?0:a(e,i,function(){return o++})}var o=1,i="nr@id",a=e("gos");n.exports=r},{}],loader:[function(e,n,t){function r(){if(!x++){var e=h.info=NREUM.info,n=d.getElementsByTagName("script")[0];if(setTimeout(s.abort,3e4),!(e&&e.licenseKey&&e.applicationID&&n))return s.abort();c(y,function(n,t){e[n]||(e[n]=t)}),f("mark",["onload",a()+h.offset],null,"api");var t=d.createElement("script");t.src="https://"+e.agent,n.parentNode.insertBefore(t,n)}}function o(){"complete"===d.readyState&&i()}function i(){f("mark",["domContent",a()+h.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(u=Math.max((new Date).getTime(),u))-h.offset}var u=(new Date).getTime(),f=e("handle"),c=e(2),s=e("ee"),p=window,d=p.document,l="addEventListener",m="attachEvent",w=p.XMLHttpRequest,g=w&&w.prototype;NREUM.o={ST:setTimeout,CT:clearTimeout,XHR:w,REQ:p.Request,EV:p.Event,PR:p.Promise,MO:p.MutationObserver};var v=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-1026.min.js"},b=w&&g&&g[l]&&!/CriOS/.test(navigator.userAgent),h=n.exports={offset:u,now:a,origin:v,features:{},xhrWrappable:b};e(1),d[l]?(d[l]("DOMContentLoaded",i,!1),p[l]("load",r,!1)):(d[m]("onreadystatechange",o),p[m]("onload",r)),f("mark",["firstbyte",u],null,"api");var x=0,E=e(4)},{}]},{},["loader"]);</script>
    <meta content="utf-8" http-equiv="encoding">
    <meta name="google-signin-client_id" content="559578500147.apps.googleusercontent.com">
    <meta name="google-signin-requestvisibleactions" content="https://schema.org/AddAction" />
    <meta name="google-signin-cookiepolicy" content="single_host_origin" />
    <link rel="stylesheet" href="/static/new_ui/assets/vendor/asPieProgress/css/progress.css">
    <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
    <script>window.jQuery || document.write('<script src="//az857794.vo.msecnd.net/static/jquery.1.10.2.min.js">\x3C/script>')</script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js" crossorigin="anonymous"></script>
    <script>window.$.ui || document.write('<script src="//az857794.vo.msecnd.net/static/jquery.ui.1.10.3.min.js">\x3C/script>')</script>

    <title>PlayPosit</title>
</head>
<body>
  <div id="navbar">
    <div class="navbar" style="margin-bottom:1em;">
      <nav>
        <div class="nav-wrapper container2">
          <a class="brand-logo hide-on-small-only" href="/dash"><img src="//az857794.vo.msecnd.net/images/logo_dog.png" height="64"><img class="hide-on-med-and-down" src="//az857794.vo.msecnd.net/images/logo_text.png" height="64"></a>
          

          <ul style="position:absolute;right:0;z-index:99;">
                          <li class="current active">
                <a                   href="/login" class="current active" id="link-0">Login</a>
                          <li class="">
                <a                   href="/join" class="" id="link-1">Signup</a>
                          <li class="">
                <a                   href="http://blog.playposit.com" class="" id="link-2">Blog</a>
                      </ul>
        </div>
      </nav>
    </div>
  </div>
  
  
  <main>
    <script type="text/template" id="modal-login-template">
  <div class="white-popup container" style="background:#fafafa;">
    <div class="wrapper-signon">
      <h5 class="header header-section">
        Single sign-on
      </h5>
      <div class="row center-align">
        <a class="col s12 m3 l3" href="https://api.edmodo.com/oauth/authorize?client_id=ab839f2006b38121a351c6145e9f270e561d667b62ef5ec29f606908abf20915&redirect_uri=https%3A%2F%2Fwww.playposit.com%2Fedmodo&response_type=token&scope=basic%20read_user_email"><img class="login-icon" src="//az857794.vo.msecnd.net/images/login-edmodo4.png" alt="login with edmodo" style="width:100px;"/></a>
        <a href="/clever" class="col s12 m3 l3"><img class="login-icon" src='//az857794.vo.msecnd.net/images/login-clever4.png' alt="login with Clever" style="width:100px;"/></a>
        <a class="col s12 m3 l3" href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=b64446cf-5d2e-4407-8559-5fbcc98b58b4&response_type=id_token&redirect_uri=https%3A%2F%2Fwww.playposit.com%2FO365&scope=openid%20profile%20email&state=12345&response_mode=form_post&nonce=exists"><img class="login-icon" src="//az857794.vo.msecnd.net/images/login-o3654.png" alt="login with office 365" style="width:100px;"/></a>
        <div class="g-signin2 col s12 m3 l3" data-scope="https://www.googleapis.com/auth/plus.profile.emails.read https://www.googleapis.com/auth/classroom.courses.readonly https://www.googleapis.com/auth/classroom.profile.emails https://www.googleapis.com/auth/classroom.rosters.readonly" data-onsuccess="onSignIn" data-onfailure="onSignInFailure" data-theme="dark" data-width="100px"></div>
      </div>
    </div>
    <div id="login-signup">
      <h5 class="header header-section">
        Login
      </h5>
      <div style="padding: 5px 20px 20px;">
        <form action="/login" method="POST">
          <div class="field input-field">
            <i class="material-icons prefix">account_circle</i>
            <input type="text" name="email" title="email" placeholder="email or username" autofocus required>
          </div>
          <div class="field input-field">
            <i class="material-icons prefix">lock</i>
            <input type="password" name="password" title="password" placeholder="password" required>
          </div>
          <div class="center-align col s12">
            <button class="btn waves-effect waves-light" type="submit" name="submit">Submit<i class="material-icons right">send</i></button>
          </div>
        </form>
      </div>
    </div>
    <br/>
    <blockquote style="font-weight:200;">
      <a href="http://playposit.uservoice.com/knowledgebase/articles/778704" target="_blank">Forgot your password?</a><br/>
      No account yet? <a href="/join">Create an account here.</a>
    </blockquote>
</script>

<!-- <script src="https://apis.google.com/js/platform.js" async defer></script> -->
<script type="text/javascript">
  $(document).ready(function(){
    $(".modal-login-trigger").click(function() {
      $.magnificPopup.open({
        items: {
          src: _.template($("#modal-login-template").html(),{}),
          type: "inline"
        },
        callbacks: {
          open: function() {

            var isPlatform = $('script').filter(function () {
              return ($(this).attr('src')!= undefined && $(this).attr('src').indexOf("platform.js") != -1);
            });

            if(isPlatform.length != 0){
              $(isPlatform).remove();
            }
            var s = document.createElement("script");
            s.type = "text/javascript";
            s.src = "https://apis.google.com/js/platform.js";
            setTimeout(function(){$("head").append(s)}, 250);
          }
        }
    });
    });
  });
	function onSignIn(googleUser) {
	  var isSignedIn = googleUser.isSignedIn();
	  if(isSignedIn){
		  var profile = googleUser.getBasicProfile();
		  var id_token = googleUser.getAuthResponse().id_token;
		  var email = profile.getEmail();
		  if(id_token){
        googleUser.disconnect();
        $.post( "/checkemail/"+email, function( data ) {
          if( data ) {
            // next 2 lines added for first time user G-sign getting pop up under magnificPopup Login modal
            var magnificPopup = $.magnificPopup.instance;
            if (magnificPopup) magnificPopup.close();
            app.listPopup('What best describes you?', [
              { title: 'STUDENT',
                href: "/googleoauth2callback?id_token="+id_token+"&user=student" },
              { title: 'INSTRUCTOR',
                href: "/googleoauth2callback?id_token="+id_token+"&user=teacher" }
            ]);
          } else {
            window.location.href = "/googleoauth2callback?id_token="+id_token;
          }
        });
      }
	  }else{
	  	error = "Google signedin failed.";
	  	emailError(error);
	  	window.location.href = "/" ;
	  }
	}

	function onSignInFailure(error) {
	  // Handle sign-in errors
	  console.log(error);
	  emailError(JSON.stringify(error, undefined, 2));
	  window.location.href = "/" ;
	}

	function emailError(error){
    gtm("Google Lesson login error", "login fail", error);
		var xhr = new XMLHttpRequest();
		xhr.open('POST', '/googlessoerror');
		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		xhr.send('error=' + error);
	}

  //Check if in Safari/iframe
  var is_safari = navigator.userAgent.indexOf("Safari") > -1;
  function inIframe () {
    try { return window.self !== window.top; }
    catch (e) { return true; }
  }
  // Popup to activate session, auto-closes
  if(is_safari && inIframe()){
    window.open("/appPopup", "loadingSession");
  }
</script>


    
<h4 id="message" class="center-align" style="color: #2196F3;">Please login to access</h4>
<div id="login-container" style="min-height:520px;"></div>

  </main>
  
    <footer class="page-footer">
      <div class="container">
        <div class="row">
          <div class="col s12">
            <h5 class="white-text">What we do</h5>
            <p class="grey-text text-lighten-4">
              Backed by AT&T and Stanford's startX, PlayPosit is an online learning environment to create and share interactive video lessons. Teachers begin with any online video (screencasts, Khan Academy, TED, etc.) and transform what is traditionally passive content into an active experience for students, with time-embedded activities. <br/><br/>Awarded the "best open educational resource", PlayPosit is designed for K-corporate, flipped, and blended environments.</p>
          </div>
        </div>
        <div class="row">
          <div class="col s6">
            <h5 class="white-text">Learn</h5>
            <ul>
              <li><a class="grey-text text-lighten-3" href="https://playposit.uservoice.com/knowledgebase" target="_blank">FAQ</a></li>
              <li><a class="grey-text text-lighten-3" href="http://blog.playposit.com/" target="_blank">Blog</a></li>
              <li><a class="grey-text text-lighten-3" target="_blank" href="http://status.playposit.com">Status</a></li>
              <li><a class="grey-text text-lighten-3" href="/premium">Premium</a></li>
              <li><a class="grey-text text-lighten-3" href="https://docs.google.com/presentation/d/1vpn_46MRA7rKkNa5WY6e2u4ZJispwrTseJ9fblfIf0A/edit?usp=sharing" target="_blank">On-Boarding</a></li>
              <li><a class="grey-text text-lighten-3" href="/learn/k12">K-HigherEd</a></li>
              <li><a class="grey-text text-lighten-3" href="/learn/corporate">Corporate</a></li>
            </ul>
            <h5 class="white-text">Terms</h5>
            <ul>
              <li><a class="grey-text text-lighten-3" href="/terms">Terms of Use</a></li>
              <li><a class="grey-text text-lighten-3" href="/privacy">Privacy Policy</a></li>
            </ul>
          </div>
          <div class="col s6">
            <h5 class="white-text">Build</h5>
            <ul>
              <li><a class="grey-text text-lighten-3" href="/panel/lessons">Bulbs</a></li>
              <li><a class="grey-text text-lighten-3" href="/panel/lessons/legacy#premade">Search</a></li>
            </ul>
            <h5 class="white-text">Deliver</h5>
            <ul>
              <li><a class="grey-text text-lighten-3" href="/roster">Roster</a></li>
              <li><a class="grey-text text-lighten-3" href="/monitor/grades#assign">Assign</a></li>
              <li><a class="grey-text text-lighten-3" href="/monitor/grades">Monitor</a></li>
            </ul>
            <br />
              <div id="google_translate_element"></div>
          </div>
        </div>
      </div>
      <div class="footer-copyright">
        <div class="container">
          &copy; 2017 <a class="grey-text text-lighten-4" href="https://www.playposit.com">PlayPosit, Inc.</a>
        </div>
      </div>
    </footer>
  
  
  <script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE, gaTrack: true, gaId: 'UA-42920959-1'}, 'google_translate_element');
    }
  </script>
  
  <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  
  <script type="text/javascript" src="//az857794.vo.msecnd.net/static/underscore.backbone.deep-model.moment.styling.magnific-popup.date.format.typeahead.js"></script>
  <!--<script type="text/javascript" src="/min/b=static/js&amp;f=underscore.js,backbone.js,deep-model.js,moment.js,styling.js,magnific-popup.js,date.format.js,typeahead-0.9.3.js?v=1.597"></script>-->
  <script>
    Backbone.emulateJSON = true;
    window.api_prefix = "/api/1.0";
    try {
      window.FromPHP = JSON.parse("{\"user\":\"\",\"url\":\"\\\/robots.txt?\",\"fail\":null,\"redirect\":\"true\",\"uuid\":null,\"temp\":\"\\\/robots.txt?\",\"classes\":null,\"referral_by\":null}");
    } catch(e) {
      //console.log(JSON.stringify(e));
    }
  </script>
  <script type="text/javascript" src="//az857794.vo.msecnd.net/static/parsley.min.js"></script>
  <script type="text/javascript" src="/min/b=static&amp;f=js/fluidvids.min.js,js/hogan-2.0.0.js,js/snap.min.js,js/panel.js,js/youtube_setup.js,js/html5slider.js,js/userfeed.js,vendor/materialize/js/materialize.js,js/jquery.nicescroll.min.js,js/jquery-asPieProgress.js,js/app.js?v=1.597"></script>
  <script src="//az857794.vo.msecnd.net/static/lazysizes.min.js" async></script>
  <script type="text/javascript">
  
    var ouruser_id = "",
        ouruser_type = "none",
        ouruser_new = false,
        ouruser_subject = "",
        ouruser_grade = "",
        ouruser_role = "",
        ouruser_school = "",
        ouruser_school_id = "",
        ouruser_premium = false,
        ouruser_premium_date = false,
        ouruser_students = "",
        ouruser_email = "",
        ouruser_name = "",
        ouruser_firstname = "",
        ouruser_fullname = "",
        ouruser_signup = "",
        ouruser_lessons = "",
        ouruser_phone = "",
        ouruser_questions = "";

    if (typeof FromPHP != "undefined" && FromPHP != null) {
      if (typeof FromPHP.student != "undefined" && FromPHP.student != null) {
        ouruser_type = "student";
        ouruser_id = FromPHP.student.id;
      } else if (typeof FromPHP.user == "object") {
        ouruser_id = FromPHP.user.id;
        ouruser_type = "teacher";
        ouruser_grade = FromPHP.user.grade_default;
        ouruser_subject = FromPHP.user.subject_default;
        ouruser_role = FromPHP.user.role;
        ouruser_school = FromPHP.user.school_name;
        ouruser_school_id = FromPHP.user.school_id;
        ouruser_email = FromPHP.user.email;
        ouruser_name = FromPHP.user.student_name;
        ouruser_firstname = FromPHP.user.first_name;
        ouruser_fullname = FromPHP.user.first_name+" "+FromPHP.user.last_name;
        ouruser_phone = FromPHP.user.school_zip;
        ouruser_signup = new Date(FromPHP.user.timestamp).getTime() / 1000;
        if (FromPHP.user.last_login.slice(-1) == ";") ouruser_new = "new_user";
      } else if (typeof FromPHP.teacher == "object") {
        ouruser_id = FromPHP.teacher.id;
        ouruser_type = "teacher";
        ouruser_grade = FromPHP.teacher.grade_default;
        ouruser_subject = FromPHP.teacher.subject_default;
        ouruser_role = FromPHP.teacher.role;
        ouruser_school = FromPHP.teacher.school_name;
        ouruser_school_id = FromPHP.teacher.school_id;
        ouruser_email = FromPHP.teacher.email;
        ouruser_name = FromPHP.teacher.student_name;
        ouruser_firstname = FromPHP.teacher.first_name;
        ouruser_fullname = FromPHP.teacher.first_name+" "+FromPHP.teacher.last_name;
        ouruser_phone = FromPHP.teacher.school_zip;
        ouruser_signup = new Date(FromPHP.teacher.timestamp).getTime() / 1000;
        if (FromPHP.teacher.last_login && FromPHP.teacher.last_login.slice(-1) == ";") ouruser_new = "new_user";
        if (FromPHP.active_students) ouruser_students = FromPHP.active_students;
      }
      if (typeof FromPHP.features != "undefined" && FromPHP.features[0] != null) {
        ouruser_premium_date = new Date(FromPHP.features[0].timstamp).getTime() / 1000;
        ouruser_premium = true;
      }
      if (typeof FromPHP.dataLayer == "object") {
        ouruser_lessons = FromPHP.dataLayer.lessons;
        ouruser_questions = FromPHP.dataLayer.questions;
      }
    }
    dataLayer = [{
      'ouruser_id': ouruser_id,
      'ouruser_type': ouruser_type,
      'ouruser_new': ouruser_new,
      'ouruser_subject': ouruser_subject,
      'ouruser_grade': ouruser_grade,
      'ouruser_role': ouruser_role,
      'ouruser_school': ouruser_school,
      'ouruser_school_id': ouruser_school_id,
      'ouruser_premium': ouruser_premium,
      'ouruser_premium_date': ouruser_premium_date,
      'ouruser_students': ouruser_students,
      'ouruser_email': ouruser_email,
      'ouruser_name': ouruser_name,
      'ouruser_firstname': ouruser_firstname,
      'ouruser_fullname': ouruser_fullname,
      'ouruser_signup': ouruser_signup,
      'ouruser_lessons': ouruser_lessons,
      'ouruser_questions': ouruser_questions,
      'ouruser_phone': ouruser_phone
    }];
    //Blocking things on edmodo
      window.onerror = function(){
        "use strict";
          var errors = Array.prototype.slice.apply(arguments);

          var error_message = errors[0];
          var error_url = errors[1];
          var error_line = errors[2];
          var error_column = errors[3]+1;

        var line_string   = isNaN(error_line) ? "" : " (line: " + error_line + "";
        var column_string = isNaN(error_column) ? "" : ", column: " + error_column + ")";
        var error_event = "[" + error_message + "][" + error_url +  line_string + column_string + "]";
        //error_event += ouruser_type + " " + ouruser_id;

        if (typeof(dataLayer) != "undefined") {
          dataLayer.push({
            'event' : "GALogger", //never changes
            'log-category' : "JSERROR", //onerror
            'log-action' : error_event,
            'log-label' : "v=1.597", //this is the version, in this exact format
            'log-value' : 1 //number only
          });
          //dataLayer.push({'event': 'on-js-error','error-output': error_event + " v=1.597" });
        }
          return errors; //make true to hide errors
      }
  
</script>

  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-M9KW84" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KW84');</script>


      
      <script>
        UserVoice=window.UserVoice||[];(function(){var uv=document.createElement('script');uv.type='text/javascript';uv.async=true;uv.src='//widget.uservoice.com/apWCQwoLM4UCHPU1RfAg.js';var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(uv,s)})();

        UserVoice.push(['set', {
          accent_color: '#ff9900',
          trigger_color: 'white',
          trigger_background_color: '#ff9900'
        }]);
        try {
            UserVoice.push(['identify', {
              //email:      'john.doe@example.com', // User’s email address
              name:       "name: "+ouruser_name, // User’s real name
              //created_at: 1364406966, // Unix timestamp for the date the user signed up
              id:         "id: "+ouruser_id, // Optional: Unique id of the user (if set, this should not change)
              type:       ouruser_type+" & role:"+ouruser_role+" & school_id:"+ouruser_school_id+" & premium:"+ouruser_premium+" "+ouruser_email, // Optional: segment your users by type
              account: {
                id:           "signup: "+ouruser_signup, // Optional: associate multiple users with a single account
                name:         "phone: "+ouruser_phone, // Account name
                //created_at:   ouruser_signup, // Unix timestamp for the date the account was created
                //monthly_rate: ouruser_phone, // Decimal; monthly rate of the account
                //ltv:          ouruser_school_id, // Decimal; lifetime value of the account
                plan:         "L: "+ouruser_lessons+"; Q: "+ouruser_questions // Plan name for the account
              }
            }]);
          } catch(e) {
            UserVoice.push(['identify', {}]);
          }
        UserVoice.push(['addTrigger', {mode: 'satisfaction', trigger_position: 'bottom-left' }]);
        UserVoice.push(['autoprompt', {}]);

        // -- pwa service worker registering
        //Add this below content to your HTML page, or add the js file to your page at the very top to register sercie worker
        if (navigator.serviceWorker.controller) {
          console.log('[PWA Builder] active service worker found, no need to register');
        }
        else {
          //Register the ServiceWorker
          function is_mobile() {
            var mobile = ['windows mobile','windows phone','iemobile'];
            for (var i in mobile) if (navigator.userAgent.toLowerCase().indexOf(mobile[i].toLowerCase()) > 0) return true;
            return false;
          }

          if(is_mobile()) {
            navigator.serviceWorker.register(window.location.origin+'/pwabuilder-sw-offline.js').then(function(reg) {
              console.log('Service worker has been registered for scope:'+ reg.scope);
            });
          }
        }
        // -- pwa service worker registeration ends --

      </script>
    
    
<script type="text/javascript">
$(document).ready(function(){
	if (FromPHP && FromPHP.fail) alert("Incorrect password or username!");
	//if (FromPHP && FromPHP.uuid) alert("Incorrect!"+FromPHP.uuid);
    $("#login-container").append(_.template($("#modal-login-template").html(),{}));
    var s = document.createElement("script");
    s.type = "text/javascript";
    s.src = "https://apis.google.com/js/platform.js";
    $("head").append(s);
  });

	if(FromPHP.uuid != null){
    app.toast('NOTE: There is problem in Google SSO. Please report your Error Code: '+FromPHP.uuid+' to admin', 50000, 'red accent-4');
  }

  document.cookie = 'playposit=1';
  if(document.cookie.indexOf("playposit") == -1) {
    console.log("Cookies needed.");
    app.toast("Third party cookies are blocked."+"&nbsp;"+"<a class='orange-text' href='https://playposit.uservoice.com/knowledgebase/articles/916320' target='_blank'>Enable?</a>", 10000, 'blue accent-4');
    var url = FromPHP.url;
    if(url && url.indexOf("temp") > -1) {
      var link = url.match(/\/play\/.+temp=(.*)/);
      if (link && link[1]) {
        url = decodeURIComponent(link[1]);
      }    
    }
    document.getElementById("message").innerHTML = "Third party cookies are blocked.<br/><a class='orange-text' href='https://playposit.uservoice.com/knowledgebase/articles/916320' target='_blank'>Enable?</a><br><a class='orange-text' href='"+url+"' target='_blank'>Open in New Window?</a>";
  } else {
    console.log("cookie set");
  }
</script>

  <script type="text/template" id="modal-create-lesson-template">
  <form id="lesson-form" data-parsley-validate>
    <div class="card modal-content teacher-view permanent-scroll" style="margin-bottom:0;">
      <div class="card-heading row light-blue" style="">
        <div class="col s3 m6">
          <h3 class="card-title"><%= (prepop === true) ? "Edit" : "Create" %> Video Bulb</h3>
        </div>
        <% if (prepop !== true) { %>
        <div class="col s9 m6" style="display:none">
          <ul class="light-blue tabs" style="margin-top:10px;">
            <li class="tab col s6 right"><a class="" href="#add-video">Add Video</a></li>
            <li class="tab col s6 disabled" style="display:none"><a href="#lesson-criteria" style="min-height: 480px;">Details</a></li>
          </ul>
        </div>
        <% } %>
      </div>
      <% if (prepop !== true) { %>
      <div id="add-video">
        <div class="section row" style="">
          <h4 class="grey-text header text-darken-2">Know which video to use?</h4>
          <div class="col m8">
            <div class="input-field">
              <input class="labeled" type="text" id="video_id" name="video_id" />
              <label class=""
                     data-label="Accepts YouTube, Vimeo, TeacherTube, Shmoop, SchoolTube, and others
                     for school licenses!" data-error="Invalid video url" for="video_id">
                Video URL
              </label>
            </div>
          </div>
            <div class="col m4">
              <a id="add-video-continue" class="btn btn-raised btn-block disabled btn-large blue white-text">Continue</a>
               <div id="video-loader" class="progress" style="display:none;">
                  <div class="indeterminate"></div>
              </div>
            </div>
        </div>
        <div class="section row">
          <h4 class="grey-text header">Find the perfect video for your lesson</h4>
          <br />

          <div class="col s4">
            <a href="/panel/lessons/legacy#premade" target="_blank"
               class="btn btn-raised btn-medium  btn-block green accent-4 white-text">
              Browse Premade Bulbs
            </a>
          </div>
          <div class="col s4">
            <a href="/panel/lessons/legacy#channels" target="_blank"
               class="btn btn-raised btn-medium  btn-block orange accent-4 white-text">Search Video Channels</a>
          </div>
          <div class="col s4">
            <select name="menu" onChange="window.document.location.href=this.options[this.selectedIndex].value;" value="Video Hosts">
                <option selected="selected" disabled="disabled">Video Hosts</option>
                <option value="/kaltura">Kaltura</option>
                <option value="/warpwire/video">WarpWire</option>
            </select>
          </div>
          
        </div>

      </div>
      <% } %>
      <div id="lesson-criteria" class="section row">

        <div class="section" style="clear:both;">
          <% if (prepop !== true) { %>
            <div class="col s4 center-align">
              <div id="create-lesson-thumbnail"></div>
            </div>
          <% } else { %>
            <div class="col m4">
            <h6 style="margin:-20px 0 16px 0" class="blue-text">Bulb Details</h6>
              <img class="responsive-img"
                 src="<%= (lesson.thumbnail) ? lesson.thumbnail : '/api/1.0/lesson/' + lesson.id + '/thumbnail.jpg' %>">
            </div>
          <% } %>


          <div class="col s8">
            <div class="input-field" style="margin-top:0;">
            <% if (prepop === true) { %>
              <input id="cl_video_id" name="video_id" value="<%= lesson.video_id %>"  data-error="Invalid video url" type="text" required="">
              <label class="<%= (lesson.title) ? 'active' : '' %>" for="cl_title">Change Video URL</label>
            </div>

            <div class="input-field">
            <% } %>
              <input id="cl_title" name="title" key="title" value="<%= lesson.title %>"  data-error="A lesson title is required" type="text" required="">
              <label class="<%= (lesson.title) ? 'active' : '' %>" for="cl_title">Lesson Title</label>
            </div>
            <div class="input-field">
              <input id="learning_objective" name="learning_objective" key="learning_objective" data-error="A learning objective is required" value="<%= lesson.learning_objective %>" type="text" required />
              <label for="learning_objective" class="<%= (lesson.learning_objective) ? 'active' : '' %>">Learning Objective</label>
            </div>
          </div>
        </div>
        <div class="section" style="clear:both;">
          <div class="col m4">
            <div class="input-field">
              <label for="cl_grade" class="active">Grade Level</label>
              <select class="browser-default browser-default-styled" id="cl_grade" name="grade" key="grade" required>
                <option value="" class="grey-text" disabled <%= (teacher.grade_default == undefined) ? "selected" : "" %>>Choose Grade</option>
                <% _.each(grades, function(item) { %>
                <option value="<%= item %>" <%= (lesson.grade == item || (!lesson.grade && teacher.grade_default == item)) ? 'selected' : '' %>><%= item %></option>
                <% }); %>
              </select>
            </div>
          </div>
          <div class="col m4">
            <div class="input-field">
              <label for="cl_topic" class="active">Subject</label>
              <select class="browser-default browser-default-styled" id="cl_topic" name="topic" key="topic" onchange="injectTpl('cl-subtopic', { subtopics: FromPHP.subtopics[this.value]})" required>
                <option value="" class="grey-text"  <%= (teacher.subject_default == undefined) ? "selected" : "" %> disabled>Choose subject</option>
                <% _.each(topics, function(item) { %>
                  <option value="<%= item %>" <%= (lesson.topic == item || (!lesson.topic && teacher.subject_default == item)) ? 'selected' : '' %>><%= item %></option>
                <% }); %>
              </select>
            </div>
          </div>
          <div class="col m4">
            <div class="input-field" id="cl-subtopic">
              <label for="cl_subtopic" class="active">Subtopic</label>
              <select class="browser-default browser-default-styled" id="cl_subtopic" name="subtopic" key="subtopic" required>
                <option value="" class="grey-text" disabled <%= (lesson.subtopic) ? "" : "selected" %>>Choose Subtopic</option>
                <% if (lesson.topic) {
                  _.each(FromPHP.subtopics[lesson.topic], function(item) { %>
                  <option value="<%= item.subtopic %>" <%= (lesson.subtopic == item.subtopic) ? "selected" : "" %>><%= item.subtopic %></option>
                <% });
                } else if (teacher.subject_default) {
                  _.each(FromPHP.subtopics[teacher.subject_default], function(item) { %>
                  <option value="<%= item.subtopic %>" <%= (lesson.subtopic == item.subtopic) ? "selected" : "" %>><%= item.subtopic %></option>
                  <% });
                } %>
              </select>
            </div>
          </div>
          <div class="col m12">
            <div class="input-field" id="ccss-field">
              <input id="ccss" type="text" name="ccss" class="CCSS-typeahead" style="width:100%;" value="<%= lesson.ccss %>" />
              <input type="hidden" class="ccss-identified <%= (lesson.video_id) ? 'active' : '' %>" name="ccss-identified" />
              <p class="ccss-text"></p>
            </div>
          </div>
        </div>
        <div class="section" style="clear:both;">
          <h6 class="blue-text">Settings</h6>
          <div class="col m8">
            <!--<div style="margin:16px 0;">
              <div class="switch" id="firewall-bypass" style="<%= ((!teacher.school_id && !FromPHP.premiumCheck) || ( (!lesson.video_id || lesson.video_id.toString().indexOf('http://light.dog/proxy/?url=') < 0) && (lesson.source != 0 || !lesson.video_id) ) ) ? 'display:none;' : '' %>">
                <label>
                  <h6 class="grey-text text-darken-4" style="display:inline">Network Firewall Bypass (<a target="_blank" href="http://playposit.uservoice.com/knowledgebase/articles/772362">questions?</a>)</h6>
                  <input name="youtube_firewall" type="checkbox" <%= (lesson.video_id && lesson.video_id.toString().indexOf('http://light.dog/proxy/?url=') >= 0) ? "checked" : "" %>  class="editable-checkbox" />
                  <span class="lever right"></span>
                </label>
              </div>
            </div>-->
            <div style="margin:16px 0;">
              <div class="switch">
                <label>
                  <h6 class="grey-text text-darken-4" style="display:inline">Rewind during Questions</h6>
                  <input type="checkbox" name="rewind_yes" class="editable-checkbox" <%= (lesson.rewind_yes) ? "checked" : "" %> id="rewind_yes" key="rewind_yes" />
                  <span class="lever right"></span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <% if (prepop === true) { %>
        <input type="submit" class="waves-effect blue-text waves-light btn-flat right" value="SAVE" />
      <% } %>
      <a href="javascript:void(0)" class="modal-action modal-close waves-effect waves-light btn-flat right">Cancel</a>
    </div>
  </form>
</script>

<div id="modal-create-lesson" class="modal modal-fixed-footer">
</div>
<script type="text/template" id="cl-subtopic-template">
  <label for="cl_subtopic" class="active">Subtopic</label>
  <select class="browser-default browser-default-styled" id="cl_subtopic"  name="subtopic" key="subtopic" required>
    <option value="" class="grey-text" selected disabled>Choose Subtopic</option>
    <% _.each(subtopics, function(item) { %>
    <option value="<%= item.subtopic %>"><%= item.subtopic %></option>
    <% }); %>
  </select>
</script>

<script type="text/javascript">
  
  window.EditLesson = Backbone.Model.extend({
    defaults: function () {
      return {
        title: '',
        grade: '',
        topic: '',
        subtopic: '',
        learning_objective: '',
        video_id: "",
        rewind_yes: null,
        source: 2,
        duration: null
      };
    },
    initialize: function (attrs) {
      if(FromPHP["slesson"]){
        this.Student = attrs.Student;
      } else {
        this.Teacher = attrs.Teacher;
      }
    },
    analytics: function() {
      var questions = lessonView.questions.models,
          data = {
            "bloom":[0,0,0,0,0,0],
            "types":[0,0,0,0,0], //MC, Check all, FR, SA
            "media":[0,0,0],
            "feedback_ratio":[0,0,0] // (applicable) questions, answers, feedback
          };

      // Perform analytics on each question and return the cumulative sum
      for (var i in questions) {
        var q = questions[i],
            q_data = q.analyze(q);
        for (var j in q_data) {
          for (var k in q_data[j]) {
            data[j][k] += q_data[j][k];
          }
        }
      }
      var dur = this.get("duration");
      if (dur) {
        dur = dur.split(',');
        data['duration'] = parseInt(dur[1], 10) - parseInt(dur[0], 10);
      } else {
        data['duration'] = lessonView.videoView.player.getDuration();
      }
      return data;
    },
    score: function(analysis) {
      var score = 2,
          labels = ['Good', 'Very Good', 'Excellent'],
          fbr = Math.round(analysis.feedback_ratio[2]*100/analysis.feedback_ratio[1]),
          qr = ((analysis.types[0] + analysis.types[1] + analysis.types[2] + analysis.types[3]) * 60 / analysis.duration).toFixed(1),
          cr = (analysis.feedback_ratio[1] / analysis.feedback_ratio[0]).toFixed(2);

      function subThres(stat, range, min) {
        for (var i=0; i<range; i++) {
          if (stat[i] <= min) return true;
        }
        return false;
      }
      if (subThres(analysis.bloom, 6, 0) || subThres(analysis.types, 4, 1) ||
          fbr <= 0 || qr <= 1 || cr < 3) {
        score = 0;
      } else if (subThres(analysis.bloom, 6, 2) || subThres(analysis.types, 4, 2) ||
          fbr <= 50 || qr <= 2 || cr < 4) {
        score = 1;
      }
      return [score, labels[score]];

    },
    urlRoot: function () {
      //If slesson, student-made lesson; else teacher (regular) lesson
      return api_prefix + "/teachers/" + FromPHP.teacher.id + "/lessons";
    }
  });

  var lessonObj;

  function firewallBypass(value) {
    var videoUrl = lessonObj.get('video_id');
    var proxyUrl = "http://light.dog/proxy/?url=";
    if (value) {
      var videoIdentifier = videoUrl;
      if (!videoUrl.indexOf(proxyUrl) >= 0) {
        videoUrl = proxyUrl + videoUrl;
      } else {
        videoIdentifier.replace(proxyUrl, ""); //get ID
      }
      $.get( "/videodetails/"+videoIdentifier, function( creativeCommons ) {
        if (creativeCommons) {
          lessonObj.set('video_id', videoUrl);
          lessonObj.set('source', 2);
          lessonObj.save();
        } else {
          alert("This video is not creative commons licensed. As an owner of this video you can license the video as creative commons from youtube.com/my_videos.");
        }
      });
    } else if (value === false) {
      if (videoUrl.indexOf(proxyUrl) == 0)
        videoUrl = videoUrl.replace(proxyUrl, '');
      lessonObj.set('source', 0);

      lessonObj.set('video_id', videoUrl);
      lessonObj.save();
    } else {
      app.error("Invalid value passed for firewall bypass");
      return
    }
  }

  function renderTypeahead() {
    if (typeof $('.CCSS-typeahead').typeahead != "undefined") {
      $(".CCSS-typeahead").typeahead('destroy');
      var gradeLevel, standardSubject,
          grade = lessonObj.get('grade'),
          topic = lessonObj.get('topic');
      if (grade == "K-5th")
        gradeLevel = "3rd-5th,Other";
      gradeLevel = (grade == "3rd-5th" || grade=="6th-8th" || grade=="9th-12th" || grade=="Other") ? grade : gradeLevel;
      standardSubject = (topic == "Math" || topic=="Science" || topic=="English") ? topic : false;
      if (!gradeLevel || !standardSubject) {
        $('#ccss-field').fadeOut(800);
        lessonObj.set('ccss', '');
        lessonObj.save();
      } else {
        $('#ccss-field').show();
        $('#ccss').css('visibility', 'visible');
        $('.ccss-text').html(function(i, html) {
          return html.replace(/([^ ]+) /, '<span style="font-weight:bold">$1</span> ');
        });

        var url = '/ccss/topic/' + standardSubject + '/grade/' + gradeLevel;
        $('.CCSS-typeahead').typeahead({
          name: gradeLevel+"-and-"+topic,
          valueKey: 'standard_title',
          prefetch: {
            url: url,
            filter: function(parsedResponse) {
              Standards = _.map(parsedResponse, function(standard) {
                standard["tokens"] = standard["tokens"].replace(/,\s/g, ',').replace(/(\r\n|\n|\r)/gm,"").split(',');
                return standard;
              });
              return Standards;
            }
          },
          template: [
            '<p class="tt-suggestion"><strong>{{identifier}}</strong> {{standard_title}}</p>'
          ].join(''),
          engine: Hogan
        });

        $('.CCSS-typeahead').attr("placeholder", "Search Standards");
        $('.CCSS-typeahead').on("typeahead:selected typeahead:autocompleted", function(e,datum) {
          $(".ccss-identified").val(datum.identifier+": "+datum.standard_title);
        });
        $('.CCSS-typeahead').on("typeahead:selected typeahead:autocompleted", function(dat) {
          var val = $('.ccss-identified').val();
          //console.log(val);
          lessonObj.set('ccss', val);
        });
      }
    }
  }
  var saveOnly = false;
  var editDeferred;
  function prepopLesson(lesson) {
    editDeferred = $.Deferred();
    if (typeof lesson == "number")
      lesson = app.getById(lesson, "lessons");

    lessonObj = new EditLesson(lesson);
    injectModal('modal-create-lesson', {
      prepop: true,
      lesson: lesson,
      teacher: FromPHP.teacher,
      grades: FromPHP.grades,
      topics: FromPHP.topics,
      subtopics: FromPHP.subtopics
    });
    saveOnly = true;
    bindEvents(true);
    renderTypeahead();
    return editDeferred.promise();
  }

  function prepopLessonSML(lesson) {
    editDeferred = $.Deferred();
    if (typeof lesson == "number")
      lesson = app.getById(lesson, "lessons");

    lessonObj = new EditLesson(lesson);
    injectModal('modal-create-lesson', {
      prepop: true,
      lesson: lesson,
      teacher: FromPHP.teacher,
      grades: FromPHP.grades,
      topics: FromPHP.topics,
      subtopics: FromPHP.subtopics
    });
    saveOnly = true;
    bindEvents(true);
    renderTypeahead();
    $('#modal-create-lesson').openModal({
      dismissible: false,
      ready: function() {
        $("label[for='cl_title']").addClass("active").text("Input Video URL");
        $("input[type='submit']").attr("disabled",true);
      }
    });
    $('.modal-close').hide()
    return editDeferred.promise();
  }

  function injectCreateLesson(){
    lessonObj = {
      title: '',
      grade: FromPHP.teacher.grade_default,
      topic: FromPHP.teacher.subject_default,
      subtopic: '',
      learning_objective: '',
      source: 0,
      rewind_yes: null,
      duration: null
    };
    saveOnly = false;

    injectTpl('modal-create-lesson', {
      prepop: false,
      lesson: lessonObj,
      teacher: FromPHP.teacher,
      grades: FromPHP.grades,
      topics: FromPHP.topics,
      subtopics: FromPHP.subtopics
    });
    $('#modal-create-lesson').find('ul.tabs').tabs();
    bindEvents();
    $('#modal-create-lesson').openModal({
      dismissible: false,
      // opacity: .5, // Opacity of modal background
      // in_duration: 300, // Transition in duration
      // out_duration: 200, // Transition out duration
      ready: function() {
        $("#modal-create-lesson form .permanent-scroll").niceScroll({autohidemode:false,cursorcolor:"rgba(0,0,0,0.3)",cursorborder: "0px solid transparent", cursorwidth:8});
      }, // Callback for Modal open
      complete: function() { } // Callback for Modal close
    });

  }

  function bindEvents(preprop) {
    $("#lesson-form").parsley();
    $("#lesson-form").find(".parsley-errors-list").each(function() {
      $(this).appendTo($(this).parent());
    })
    $("#lesson-form").on('submit', function(e) {
      var form = $("#lesson-form").parsley();
      if (form.isValid()) {
        lessonObj.save().then(function() {
          if (!saveOnly) {
            window.location.href = "/panel/edit/" + lessonObj.get('id');
          } else {
            $('#modal-create-lesson').closeModal();
            editDeferred.resolve(lessonObj.toJSON());
          }
        });
      } else {
      }
      e.preventDefault();
      return;
    });
    $('input[type=submit]').click(function() {
      var form = $("#lesson-form").parsley();
      if (!form.isValid())
        app.error("A required field needs to be filled out before continuing");
    });
    var raceCondition = 0;
    $("#cl_video_id").on("keyup change", _.debounce(function() {
      youtubeSearch($(this).val()).then(function(videoId) {
        lessonObj.set('video_id', videoId);
        lessonObj.set('duration', '');
        $("#cl_video_id").addClass("valid").removeClass('invalid');
        $("input[type='submit']").removeAttr("disabled");
      }, function() {
        $("#cl_video_id").removeClass("valid").addClass('invalid');
        app.error('Invalid video id', '#cl_video_id');
      });
    }, 1000));

    $('#video_id').on("keyup change", _.debounce(function() {
      $("#video-loader").show();
      youtubeSearch($(this).val()).then(function(videoId) {
        $('#video_id').prop('disabled', true).removeClass('invalid').addClass('valid');

        if (typeof lessonObj.get != "function") {
          lessonObj.video_id = videoId;
          //console.log('race condition: ' + raceCondition);
          if (raceCondition === 0) {
            raceCondition = 1;
          } else {
            return
          }
          $.ajax({
            data: {
              model: JSON.stringify(lessonObj)
            },
            url: "/api/1.0/teachers/" + FromPHP.teacher.id + "/lessons",
            type: "POST",
            success: function (data) {
              lessonObj = new EditLesson(data);

              $("#lean-overlay, #modal-create-lesson .modal-close").unbind('click').click(function() {
                app.confirm(["Abandon progress on this lesson?", "Current progress on this lesson will be lost"],"ABANDON", "CANCEL").then(function(){
                  $("#modal-create-lesson").closeModal();
                  $.ajax('/api/1.0/teachers/'+FromPHP.teacher.id+'/lessons/'+lessonObj.get('id'), {
                    type: "DELETE"
                  });
                });
              });

              $('#modal-create-lesson').find('li.disabled').show().removeClass('disabled');
              $('#modal-create-lesson').find('li.right').removeClass('right');
              renderTypeahead();
              $('#add-video-continue').removeClass('disabled');
              $("#video-loader").remove();
              $('#add-video-continue').unbind('click');
              $('#add-video-continue').click(function () {
                $('#create-lesson-thumbnail').html('<img class="responsive-img" src="/api/1.0/lesson/' + lessonObj.get('id') + '/thumbnail.jpg' + '" />');
                $('#modal-create-lesson').tabs('select_tab', 'lesson-criteria');
                $('#modal-create-lesson').find('.modal-footer').prepend(
                    $('<input id="beginBuild" type="submit" class="waves-effect blue-text waves-light btn-flat right" value="Begin Building">').click(function() {
                      var form = $("#lesson-form").parsley();
                      if (!form.isValid()) {
                        gtm('create-bulb-begin-building-error', 'begin-building-error', lessonObj.get('id'));
                        app.error("A required field needs to be filled out before continuing");
                      }
                      else gtm('create-bulb-begin-building-success', 'begin-building-success', lessonObj.get('id'));
                    })
                );
              });
              $("#beginBuild").remove();
            }
          });
        } else {
          lessonObj.set('video_id', videoId);
        }
      }, function() {
        //console.log('id error');
        app.error('Invalid video id', '#video_id');
        $('#add-video-continue').unbind('click');
      });
    }, 1000));

    $("#firewall-bypass").find('input[type=checkbox]').change(function(e) {
      firewallBypass($(this).prop('checked'));

    });

    $("#lesson-criteria").find(".switch input[key]").change(function() {
      var val = ($(this).prop('checked')) ? '1' : '0',
          key = $(this).attr('key');
      //console.log(val);

      lessonObj.set(key, val);
    });
    app.bindToUI(function(target) {
      $(target).find('*[key]:not([type=checkbox])').change(function() {
        var key = $(this).attr('key');
        lessonObj.set(key, jsonEscape($(this).val()));
        //console.log({key:key, val:$(this).val()});
        if (key == "grade" || key == "topic") {
          renderTypeahead();
        }
      });
    })

  }

  $(document).ready(function(){
    app.requireVars(['teacher','grades', 'topics', 'subtopics']).then(function() {
      $('.create-lesson-trigger').click(injectCreateLesson);
    });
  });

  function youtubeSearch(q) {
    window.isVimeo = false;
    window.isTT = false;
    var shmoopre = /shmoop\.com\/video\/(.+)/;
    var archivere = /\.mp4/;
    var schooltubere = /schooltube\.com\/(?:embed|video|embed_force)\/([A-Za-z0-9]+)\//;
    var wistiare = /wistia\.com\/medias\/([A-Za-z0-9]+)/;
    var ytre = /^(?:https?:\/\/)?(?:(?:www|m)\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
    var drivere = /drive\.google\.com.*\/([-\w]{25,})/;
    var urlre = /((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www\.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/;
    var vimre = /^(?:https?:\/\/)?(?:player\.)?(?:www\.)?vimeo.com\/(?:video\/|channels\/|groups\/([^\/]*)\/videos\/|album\/(\d+)\/video\/|)(\d+)(?:$|\/|\?)/;
    var teachertubere = /^(?:https?:\/\/)?(?:(?:www)\.)?(?:teachertube\.com\/(?:embed\/)?video)\/(?:.*-)?(\d+)(?!.*\d).*/;
    var videoId = (q.match(ytre)) ? RegExp.$1 : false;
    $('#firewall-bypass').hide();
    var defer = $.Deferred();
    if (videoId) {
      isVimeo = false;
      isTT = false;
      console.log('yt');
      if (typeof lessonObj.set == "function"){
        lessonObj.set({
          "source": 0,
          "az_sas_url":"",
          "thumbnail":"https://i.ytimg.com/vi/"+videoId+"/hqdefault.jpg"
        }, {silent:true});
      }else{
        lessonObj.source = 0;
        lessonObj.az_sas_url = "";
        lessonObj.thumbnail = "https://i.ytimg.com/vi/"+videoId+"/hqdefault.jpg";
      }
      if ((FromPHP.features && FromPHP.features.length > 0 && FromPHP.teacher.id < 245018) || FromPHP.teacher.school_id) {
        console.log("show");
        $('#firewall-bypass').show();
      }
      defer.resolve(videoId);
    } else if (q.match(vimre)) {
      console.log('vim');
      var vimId = q.match(vimre)[3];
      isVimeo = true;
      if (typeof lessonObj.set == "function")
        lessonObj.set({
          "source": 1
        }, {silent:true});
      else
        lessonObj.source = 1;
      defer.resolve(vimId);
    } else if (q.match(teachertubere)) {
      var teacherTubeId = q.match(teachertubere)[1];
      //var TTUrl = q.match(teachertubere).input;
      var TTUrl = "http://www.teachertube.com/video/"+teacherTubeId;
      isTT = true;
      if (typeof lessonObj.set == "function")
        lessonObj.set({
          "source": 2
        }, {silent:true});
      else { lessonObj.source = 2; }
      $.ajax({
        type: "POST",
        url: "/teachertube",
        data: {'TTUrl': TTUrl}
      }).success( function( data ) {
        TTObj = JSON.parse(data);
        mp4File = TTObj['TTUrl'];
        var mp4thumb = TTObj['TTThumbnail'];
        if (typeof lessonObj.set == "function") {
            lessonObj.set({
              "thumbnail": mp4thumb
            }, {silent:true});
        } else { lessonObj.thumbnail = mp4thumb; }
        defer.resolve(mp4File);
      });
      // defer.resolve(teacherTubeId);
    } else if (q.match(drivere)) {
      if ($( ".toast" ).length == 0) app.toast('Deprecated: Google Drive no longer integrates video within PlayPosit '+"&nbsp;"+' <a target="_blank" href="https://playposit.uservoice.com/knowledgebase/articles/1078186"> link</a>', 8000, 'green accent-4');
      isTT = true;
      if (typeof lessonObj.set == "function")
        lessonObj.set({
          "source": 2
        }, {silent:true});
      else
        lessonObj.source = 2;
      var driveId = q.match(drivere)[1];
      defer.resolve(driveUrl = 'https://googledrive.com/host/'+driveId);
      //defer.resolve(driveUrl = 'https%3a%2f%2fgoogledrive.com%2fhost%2f'+driveId);
    } else if (q.match(wistiare)) {
      var wistiaID = q.match(wistiare)[1];
      isTT = true;
      if (typeof lessonObj.set == "function")
        lessonObj.set({
          "source": 2
        }, {silent:true});
      else
        lessonObj.source = 2;
      $.ajax({
        type: "POST",
        url: "/wistia/"+wistiaID,
        data: {'wistiaId': wistiaID}
      }).success( function( data ) {
        if(!app.IsJsonString(data)) return;
        WistiaObj = JSON.parse(data);
        mp4File = WistiaObj['url'];
        var mp4thumb = WistiaObj['thumbnail'];
        if (typeof lessonObj.set == "function")
          lessonObj.set({
            "thumbnail": mp4thumb
          }, {silent:true});
        else
          lessonObj.thumbnail = mp4thumb;

        defer.resolve(mp4File);
      });
    } else if (q.match(shmoopre)) {
      var shmoopUrl = q.match(shmoopre).input;
      if (shmoopUrl.indexOf("www.shmoop.com") == -1) q = q.replace('shmoop.com','www.shmoop.com');
      isTT = true;
      if (typeof lessonObj.set == "function")
        lessonObj.set({
          "source": 2
        }, {silent:true});
      else
        lessonObj.source = 2;
      var shmoopId = q.match(shmoopre)[1];
      shmoopId = shmoopId.replace(/\/$/, "");
      $.ajax({
        type: "POST",
        url: "/shmoop",
        data: {'shmoopUrl': shmoopUrl, 'shmoopId': shmoopId}
      }).success( function( data ) {
        shmoopObj = $.parseJSON(JSON.parse(data));
        shmoopUrl = "http://d395x7ewlfzo3v.cloudfront.net/"+shmoopObj["file"];

        defer.resolve(shmoopUrl);
      });
    }
    else if (q.match(schooltubere)) {
      var schooltubeId = q.match(schooltubere)[1];
      ////console.log(schooltubeId);
      //var schooltubeUrl = 'http://www.schooltube.com/embed_force/'+schooltubeId;
      isTT = true;
      if (typeof lessonObj.set == "function")
        lessonObj.set({
          "source": 2
        }, {silent:true});
      else
        lessonObj.source = 2;
      $.ajax({
        type: "POST",
        url: "/schooltube",
        data: {'schooltubeId': schooltubeId}
      }).success( function( data ) {
        var schooltubeObj = JSON.parse(data);
        var schooltubeUrl = schooltubeObj["STurl"];
        var mp4thumb = schooltubeObj['STthumb'];
        if (typeof lessonObj.set == "function")
          lessonObj.set({
            "thumbnail": mp4thumb
          }, {silent:true});
        else
          lessonObj['thumbnail'] = mp4thumb;
        defer.resolve(schooltubeUrl);
      }).error( function() {
        alert("There has been a problem with schooltube. Please email schooltube@playposit.com with the URL you used to solve.");
      });
    }
    else if (q.match(archivere)) {
      isTT = true;
      if (typeof lessonObj.set == "function")
        lessonObj.set({
          "source": 2
        }, {silent:true});
      else
        lessonObj.source = 2;
      defer.resolve(archiveUrl = q.match(archivere).input);
    }
    else {
      return defer.reject();
    }
    return defer.promise();
  }

  function callWarpwire(){
    $.ajax({
      type: "GET",
      url: "/ww/api/auth",
      //data: {'shmoopUrl': shmoopUrl, 'shmoopId': shmoopId}
    }).success( function( data ) {
      //console.log("ww data: ",data);
      if(data == ""){
        alert("Something is wrong. Please contact administrator");
        window.location.href="/"; // we have to change it to the default case
      }
      $("#modal-create-lesson").html("");
      if(data.indexOf("response_type=code")>-1){
        $("#modal-create-lesson").html('<iframe style="width:100%;height:100%;overflow:hidden" src="'+data+'" width="100%" height="100%"></iframe>');
      }else{
        $("#modal-create-lesson").html(data);
      }

    });
  }
  
</script>

  <script type="text/template" id="modal-confirm-template">
  <div class="modal-content">
    <% if (typeof message == "object") { %>
    <h5 class="grey-text text-darken-3" style="margin-top:0;margin-bottom:1rem;"><%= message[0] %></h6>
    <h6 class="grey-text"><%= message[1] %></h6>
    <% } else { %>
      <h6 class="grey-text"><%= message %></h6>
    <% } %>
  </div>
  <div class="modal-footer">
    <a href="javascript:void(0)" class="waves-effect blue-text btn-flat confirm-ok right"><%= confirm %></a>
    <a href="javascript:void(0)" class="waves-effect blue-text btn-flat confirm-dismiss right"><%= cancel %></a>
  </div>
</script>
<div id="modal-confirm" class="modal modal-fixed-fotter"></div>
  <script type="text/template" id="modal-list-template">
    <div class="modal-content collection section row" style="padding:0;margin-bottom:0">
      <div class="collection-item">
          <h5 style="padding:8px 0" class="card-title black-text"><%= title %></h5>
      </div>
      <% _.each(items, function(item) { %>

      <a class="collection-item grey-text" href="<%= (item.href) ? item.href : 'javascript:void(0)' %>"
         <% if (item.onclick) { %>onclick="<%= item.onclick %>" <% } %>
         ><%= item.title %>
      </a>

      <% }); %>
    </div>
</script>
<div class="modal" id="modal-list" style="max-width:300px;"></div>
<script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","licenseKey":"923bbb1839","applicationID":"13537119","transactionName":"YQYAYUVTW0dSWxIKVlhMN0deHVxaV10eTUleEw==","queueTime":0,"applicationTime":36,"atts":"TUEDFw1JSEk=","errorBeacon":"bam.nr-data.net","agent":""}</script></body></html>
